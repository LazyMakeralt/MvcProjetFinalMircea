@model MvcProjetFinalMircea.Models.Article
@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager

<h1>@Model.Titre</h1>

<p class="text-muted">
    Auteur : <strong>@Model.Auteur?.UserName</strong><br />
    Publié le : @Model.DateCreation.ToString("dd/MM/yyyy")
</p>

<div class="mb-4">
    <p>@Model.Contenu</p>
</div>

<hr />

<!-- le systeme de like l'user doit etre authent sinon il ne peut pas liker' -->
@if (User.Identity.IsAuthenticated)
{
    var user = await UserManager.GetUserAsync(User);
    bool hasLiked = Model.Likes.Any(l => l.UserId == user.Id);

    <form asp-action="ToggleLike" method="post" class="d-inline">
        <input type="hidden" name="id" value="@Model.Id" />

        @if (hasLiked)
        {
            <button class="btn btn-danger">
                💔 Unlike (@Model.Likes.Count)
            </button>
        }
        else
        {
            <button class="btn btn-outline-danger">
                ❤️ Like (@Model.Likes.Count)
            </button>
        }
    </form>
}
else
{
    <a class="btn btn-outline-primary" asp-area="Identity" asp-page="/Account/Login">
        ❤️ Like (@Model.Likes.Count) — Connectez-vous
    </a>
}

<hr />
<h4>Commentaires</h4>

@if (User.Identity.IsAuthenticated)
{
    <form asp-action="AjouterCommentaire" method="post">
        <input type="hidden" name="articleId" value="@Model.Id" />

        <div class="mb-3">
            <textarea name="texte" class="form-control" rows="3"
                  placeholder="Votre commentaire..."></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Commenter</button>
    </form>
}
else
{
    <p>
        <a asp-area="Identity" asp-page="/Account/Login">
            Connectez-vous
        </a> pour commenter.
    </p>
}

<hr />

@foreach (var c in Model.Commentaires.OrderByDescending(c => c.DateCreation))
{
    <div class="border rounded p-2 mb-2">
        <strong>@c.Auteur.UserName</strong>
        <small class="text-muted">
            (@c.DateCreation.ToString("dd/MM/yyyy HH:mm"))
        </small>
        <p>@c.Texte</p>
    </div>
}
<a asp-action="Index" class="btn btn-secondary">Retour</a>
